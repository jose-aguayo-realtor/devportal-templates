apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: migrate-secrets-api
  title: Migrate Secrets API
  description: Copies the secrets from HCP Vault to AWS Secrets Manager
  labels:
    realtor.com/version: 1.0.0
spec:
  owner: skyway
  type: service
  lifecycle: production
  system: skyway

  parameters:
    - title: Enter repository information
      description: |
        # Info
        Copies the values of a secret from Vault to AWS Secrets Manager.
      required:
        - repository
      properties:
        organization:
          title: Organization Name
          type: string
          description: |
            Github Organization where the repository is stored.
        repository:
          title: Repository Name
          type: string
          pattern: "^(?!.*moverdc/).*$"
          description: |
            Repository name of repository to be updated
            (Do not include MoveRDC/ in the name)
        dryRun:
          title: Perform a Dry Run to simulate a migration of secrets.
          type: boolean
          default: true

  steps:
  # Fetch defaultRead entities
    - id: call_migrate_endpoint
      action: skyway:migrate-endpoint
      name: Fetch all Selected Entities in defaultRead
      input:
        organization: ${{ parameters.organization }}
        repository: ${{ parameters.repository }}
        dryRun: ${{ parameters.dryRun }}

    # Print the output from the migration step
    - id: generate_migration_report
      action: fetch:template
      name: Generate Migration Report
      input:
        url: ./skeleton
        values:
          organization: ${{ parameters.organization }}
          repository: ${{ parameters.repository }}
          dryRun: ${{ parameters.dryRun }}

    # Display the results to the user
    - id: display_results
      action: debug:log
      name: Display Migration Results
      input:
        message: |
          Migration completed! Results have been generated.
          Check the migration-results.md file for detailed information.

  output:
    links:
      - title: Migration Results
        url: ${{ steps.generate_migration_report.output.targetDir }}/migration-results.md
    text:
      - title: Migration Summary
        content: |
          Migration for repository "{{ parameters.repository }}" in organization "{{ parameters.organization }}" has completed.
          Dry run mode: {{ parameters.dryRun ? 'enabled' : 'disabled' }}
          
          Status: ${{ steps.call_migrate_endpoint.output.success ? 'SUCCESS' : 'FAILED' }}
          
          Check the generated report for detailed results.
